\begin{vdmpp}[breaklines=true]
class InformationStation is subclass of GLOBAL

operations

(*@
\label{findFreeGarage:5}
@*)
pure public findFreeGarage : () ==> [ElevationGarage] 
findFreeGarage() == (
 let freeGarage in seq APS`garages be st freeGarage.isGarageFree()
 in
  return freeGarage;) 
pre ((APS`garages <> []) => (exists x in seq APS`garages & x.isGarageFree()));
   
(*@
\label{retriveCar:12}
@*)
public retriveCar : PaymentInfo * LicensePlate ==> ()
retriveCar(ppi, plp) == (
 dcl freeGarage : [ElevationGarage] := findFreeGarage();
 dcl parkingFee : ParkingFee;
 
 if freeGarage <> nil
  
  then if APS`validationService.validatePaymentInfo(ppi)
      then if card {x.license | x in set APS`garageDB & x.info = ppi} > 1 -- Check if more license to one payment
        
        then (let y in set APS`garageDB be st y.license = plp
        in
        (parkingFee := APS`transactionService.calculateParkingFee(plp, ppi, y.parkTime);
         printRetrivingReceipt(plp, ppi, y.parkTime, parkingFee););
        freeGarage.retriveCar(plp);
        APS`io.print("STATUS: garageDB contains: ");APS`io.print(APS`garageDB); APS`io.print("\n");)
      else 
        
        (let parkedCarInfo in set APS`garageDB be st parkedCarInfo.info = ppi
        in (
        freeGarage.retriveCar(parkedCarInfo.license);
        parkingFee := APS`transactionService.calculateParkingFee(plp, ppi, parkedCarInfo.parkTime);
        printRetrivingReceipt(plp, ppi, parkedCarInfo.parkTime, parkingFee););
        APS`io.print("STATUS: garageDB contains: ");APS`io.print(APS`garageDB); APS`io.print("\n"))
  
  else (*@\vdmnotcovered{APS`io}@*).print((*@\vdmnotcovered{"STATUS: Error - <PaymentCardInvalid>\textbackslash n"}@*))
else (*@\vdmnotcovered{APS`io}@*).print((*@\vdmnotcovered{"STATUS: Error - <NoFreeGarages>\textbackslash n"}@*));)
pre APS`garageDB <> {};
 
(*@
\label{registerCar:41}
@*)
public registerCar : LicensePlate * PaymentInfo * Time ==> () 
registerCar(plp, ppi, ptime) ==
 APS`garageDB := APS`garageDB union {mk_ParkedCarInfo(plp, ppi, ptime)}
pre mk_ParkedCarInfo(plp, ppi, ptime) not in set APS`garageDB;

(*@
\label{unRegisterCar:46}
@*)
public unRegisterCar : LicensePlate ==> ()
unRegisterCar(plp) ==
 APS`garageDB := APS`garageDB \ { parkedCarInfo|
 parkedCarInfo in set APS`garageDB & parkedCarInfo.license = plp}
pre exists x in set APS`garageDB & x.license = plp;

(*@
\label{printRetrivingReceipt:52}
@*)
public printRetrivingReceipt : LicensePlate * PaymentInfo * Time * ParkingFee ==> ()
printRetrivingReceipt(plp, ppi, ptime, pfee) == (
  APS`io.print("---------------------\n"); 
  APS`io.print("  Receiving Receipt  \n"); 
  APS`io.print("Car: "); APS`io.print(plp); APS`io.print("\n");
  APS`io.print("Parked at time: "); APS`io.print(ptime); APS`io.print("\n");
  APS`io.print("Current time: "); APS`io.print(World`timeRef.getTime()); APS`io.print("\n");
  APS`io.print("Payment method: ");
  if is_ParkingCard(ppi)
   then APS`io.print("Parking Card\n")
  else APS`io.print("Credit Card\n");
  APS`io.print("Payment fee: "); APS`io.print(pfee); APS`io.print("\n");
  APS`io.print("---------------------\n"););



end InformationStation
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[findFreeGarage:5]{findFreeGarage} & 5&100.0\% & 282 \\
\hline
\hyperref[printRetrivingReceipt:52]{printRetrivingReceipt} & 52&100.0\% & 57 \\
\hline
\hyperref[registerCar:41]{registerCar} & 41&100.0\% & 59 \\
\hline
\hyperref[retriveCar:12]{retriveCar} & 12&95.4\% & 57 \\
\hline
\hyperref[unRegisterCar:46]{unRegisterCar} & 46&100.0\% & 64 \\
\hline
\hline
InformationStation.vdmpp & & 97.7\% & 519 \\
\hline
\end{longtable}

