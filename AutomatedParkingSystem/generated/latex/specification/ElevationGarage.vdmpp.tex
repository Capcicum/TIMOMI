\begin{vdmpp}[breaklines=true]
class ElevationGarage is subclass of GLOBAL

types

public GateState = [<Open> | <Closed>];

instance variables
 EntranceGate : GateState := <Open>;
 ExitGate : GateState := <Closed>;
 parkedCar : [Car] := nil; 
 isFree : bool := true;

operations
 
(*@
\label{parkCar:15}
@*)
public parkCar : Car ==> ()
parkCar(pcar) == (
 parkedCar := pcar;
 isFree := false;)
pre parkedCar = nil; 
 
(*@
\label{handleParking:21}
@*)
public handleParking:  PaymentInfo ==> ()
handleParking(ppi) == ( 
 if not isFree
  then (
     if APS`validationService.validateLicensePlate(parkedCar.licensePlate) and 
     APS`validationService.validatePaymentInfo(ppi,parkedCar.parkingPermit)
       then (garageBusy();
          APS`informationStation.registerCar(parkedCar.licensePlate,ppi,World`timeRef.getTime());
          APS`parkingLevel.parkCar(parkedCar);
          printParkingReceipt(ppi);
          APS`io.print("STATUS: garageDB contains: ");APS`io.print(APS`garageDB); APS`io.print("\n");
          parkedCar := nil;
          garageFree();)
     else 
     (*@\vdmnotcovered{(}@*)(*@\vdmnotcovered{garageReadyForExit}@*)();  
     (*@\vdmnotcovered{APS`io}@*).print((*@\vdmnotcovered{"STATUS: Error - <ValidationFailed>\textbackslash n"}@*)); 
     (*@\vdmnotcovered{parkedCar}@*) := (*@\vdmnotcovered{nil}@*);
     (*@\vdmnotcovered{garageFree}@*)();)
     )
)
pre EntranceGate = <Open> and ExitGate = <Closed> and isFree = false; 
  
(*@
\label{retriveCar:43}
@*)
public retriveCar: LicensePlate ==> () -- Steps
retriveCar(plp) == (
 isFree := false;
 garageBusy();
 parkedCar := APS`parkingLevel.retriveCar(plp);
 garageReadyForExit();
 parkedCar := nil;
 APS`informationStation.unRegisterCar(plp);
 garageFree();
 isFree := true)
pre EntranceGate = <Open> and ExitGate = <Closed> and 
  isFree = true and APS`garageDB <> {} ; 
  
(*@
\label{isGarageFree:56}
@*)
pure public isGarageFree: () ==> bool
isGarageFree() == 
 return isFree;
 
(*@
\label{garageFree:60}
@*)
public garageFree: () ==> ()
garageFree() == (
 if EntranceGate = <Closed>
   then EntranceGate := <Open>;
 if ExitGate = <Open>
   then ExitGate := <Closed>;
 isFree := true;)
pre EntranceGate = ExitGate and isFree = false;

(*@
\label{garageBusy:69}
@*)
public garageBusy: () ==> ()
garageBusy() == (
 EntranceGate := <Closed>;)
pre EntranceGate = <Open> and ExitGate = <Closed> and isFree = false;

(*@
\label{garageReadyForExit:74}
@*)
public garageReadyForExit: () ==> ()
garageReadyForExit() == (
 if EntranceGate = <Closed>
   then EntranceGate := <Open>;
 ExitGate := <Open>;)
pre ExitGate = <Closed> and isFree = false;

(*@
\label{getGateStates:81}
@*)
public getGateStates: () ==> seq of GateState
getGateStates() ==
 return [EntranceGate, ExitGate];

(*@
\label{printParkingReceipt:85}
@*)
public printParkingReceipt : PaymentInfo ==> ()
printParkingReceipt(ppi) == (
  APS`io.print("---------------------\n"); 
  APS`io.print("  Parking Receipt  \n"); 
  APS`io.print("Car: "); APS`io.print(parkedCar); APS`io.print("\n");
  APS`io.print("Current time: "); APS`io.print(World`timeRef.getTime()); APS`io.print("\n");
  APS`io.print("Payment method: ");
  if is_ParkingCard(ppi)
   then APS`io.print("Parking Card\n")
  else APS`io.print("Credit Card\n");
  APS`io.print("---------------------\n"););

end ElevationGarage
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[garageBusy:69]{garageBusy} & 69&100.0\% & 116 \\
\hline
\hyperref[garageFree:60]{garageFree} & 60&100.0\% & 116 \\
\hline
\hyperref[garageReadyForExit:74]{garageReadyForExit} & 74&100.0\% & 58 \\
\hline
\hyperref[getGateStates:81]{getGateStates} & 81&100.0\% & 4 \\
\hline
\hyperref[handleParking:21]{handleParking} & 21&87.2\% & 72 \\
\hline
\hyperref[isGarageFree:56]{isGarageFree} & 56&100.0\% & 501 \\
\hline
\hyperref[parkCar:15]{parkCar} & 15&100.0\% & 74 \\
\hline
\hyperref[printParkingReceipt:85]{printParkingReceipt} & 85&100.0\% & 57 \\
\hline
\hyperref[retriveCar:43]{retriveCar} & 43&100.0\% & 57 \\
\hline
\hline
ElevationGarage.vdmpp & & 96.2\% & 1055 \\
\hline
\end{longtable}

